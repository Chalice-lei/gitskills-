name: é£ä¹¦ä»£ç æ›´æ–°é€šçŸ¥
on:
  push:
    branches: [ main, master ]  # ç›‘å¬ä¸»åˆ†æ”¯çš„æ¨é€äº‹ä»¶
  pull_request:
    types: [ opened, closed, reopened, synchronize ]  # ç›‘å¬PRç›¸å…³äº‹ä»¶
    branches: [ main, master ]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: è·å–äº‹ä»¶æ•°æ®
        id: get_event
        run: |
          # è¯»å–GitHubäº‹ä»¶æ•°æ®å¹¶è®¾ç½®ä¸ºç¯å¢ƒå˜é‡
          echo "EVENT_DATA=$(cat $GITHUB_EVENT_PATH | jq -c .)" >> $GITHUB_ENV

      - name: ç”Ÿæˆé£ä¹¦æ¶ˆæ¯
        id: generate_message
        run: |
          # æ ¹æ®äº‹ä»¶ç±»å‹ç”Ÿæˆä¸åŒçš„æ¶ˆæ¯å†…å®¹
          if [ "${{ github.event_name }}" = "push" ]; then
            # å¤„ç†æ¨é€äº‹ä»¶
            COMMITTER="${{ github.event.pusher.name }}"
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            REPO_NAME="${{ github.repository }}"
            BRANCH_NAME="${{ github.ref_name }}"
            COMMIT_URL="${{ github.event.head_commit.url }}"
            
            MESSAGE="ğŸ“¤ <$COMMITTER> å‘ [$REPO_NAME:$BRANCH_NAME] æ¨é€äº†æ–°ä»£ç ï¼š\n"
            MESSAGE+="ğŸ’¬ æäº¤ä¿¡æ¯ï¼š$COMMIT_MSG\n"
            MESSAGE+="ğŸ”— <$COMMIT_URL|æŸ¥çœ‹è¯¦æƒ…>"
          else
            # å¤„ç†PRäº‹ä»¶
            PR_ACTION="${{ github.event.pull_request.state }}"
            PR_AUTHOR="${{ github.event.pull_request.user.login }}"
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_NUMBER="${{ github.event.pull_request.number }}"
            PR_URL="${{ github.event.pull_request.html_url }}"
            REPO_NAME="${{ github.repository }}"
            
            if [ "$PR_ACTION" = "open" ]; then
              ACTION_EMOJI="ğŸ“¥"
              ACTION_TEXT="åˆ›å»ºäº†"
            elif [ "$PR_ACTION" = "closed" ]; then
              if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                ACTION_EMOJI="âœ…"
                ACTION_TEXT="åˆå¹¶äº†"
              else
                ACTION_EMOJI="âŒ"
                ACTION_TEXT="å…³é—­äº†"
              fi
            else
              ACTION_EMOJI="ğŸ”„"
              ACTION_TEXT="æ›´æ–°äº†"
            fi
            
            MESSAGE="$ACTION_EMOJI <$PR_AUTHOR> $ACTION_TEXT [$REPO_NAME] çš„PRï¼š\n"
            MESSAGE+="ğŸ“ #$PR_NUMBER $PR_TITLE\n"
            MESSAGE+="ğŸ”— <$PR_URL|æŸ¥çœ‹è¯¦æƒ…>"
          fi
          
          # è¾“å‡ºæ ¼å¼åŒ–åçš„æ¶ˆæ¯
          echo "MESSAGE=$MESSAGE" >> $GITHUB_ENV

      - name: å‘é€åˆ°é£ä¹¦
        run: |
          # ç”Ÿæˆç­¾åï¼ˆå¦‚æœè®¾ç½®äº†å¯†é’¥ï¼‰
          if [ -n "${{ secrets.FEISHU_SECRET }}" ]; then
            TIMESTAMP=$(date +%s)
            NONCE=$(openssl rand -hex 16)
            SIGNATURE=$(echo -n "$TIMESTAMP$NONCE${{ secrets.FEISHU_SECRET }}" | sha256sum | awk '{print $1}')
            HEADER=" -H 'X-Timestamp: $TIMESTAMP' -H 'X-Nonce: $NONCE' -H 'X-Signature: sha256=$SIGNATURE'"
          fi

          # æ„é€ é£ä¹¦æ¶ˆæ¯æ ¼å¼
          FEISHU_PAYLOAD=$(jq -n \
            --arg msg_type "text" \
            --arg text "${{ env.MESSAGE }}" \
            '{msg_type: $msg_type, content: {text: $text}}')

          # å‘é€è¯·æ±‚åˆ°é£ä¹¦æœºå™¨äºº
          eval "curl -X POST '${{ secrets.FEISHU_WEBHOOK }}' \
            -H 'Content-Type: application/json' \

            $HEADER \
            -d '$FEISHU_PAYLOAD'"

