name: Build and Notify

on:
  push:
    branches: [ main ]  # 监听main分支的push事件
  pull_request:
    branches: [ main ]  # 监听针对main分支的PR

jobs:
  build:
    runs-on: ubuntu-latest  # 使用Ubuntu环境

    steps:
    - uses: actions/checkout@v4  # 检出代码

    - name: Set up build environment
      run: |
        # 安装必要的编译工具
        sudo apt-get update
        sudo apt-get install -y g++

    - name: Make build script executable
      run: chmod +x build.sh  # 确保构建脚本可执行

    - name: Run build script
      id: build_step  # 给步骤设置ID，方便后续引用
      run: ./build.sh  # 执行构建脚本

    - name: Send success notification to Feishu
      if: success()  # 只有前面步骤成功时才执行
      run: |
        curl -X POST "${{ secrets.FEISHU_WEBHOOK }}" \
        -H "Content-Type: application/json" \
        -d '{
          "msg_type": "text",
          "content": {
            "text": "✅ 构建成功!\n仓库: ${{ github.repository }}\n分支: ${{ github.ref_name }}\n提交: ${{ github.sha }}\n提交者: ${{ github.actor }}"
          }
        }'

    - name: Send failure notification to Feishu
      if: failure()  # 只有前面步骤失败时才执行
      run: |
        curl -X POST "${{ secrets.FEISHU_WEBHOOK }}" \
        -H "Content-Type: application/json" \
        -d '{
          "msg_type": "text",
          "content": {
            "text": "❌ 构建失败!\n仓库: ${{ github.repository }}\n分支: ${{ github.ref_name }}\n提交: ${{ github.sha }}\n提交者: ${{ github.actor }}\n查看详情: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
        }'

