name: Build and Notify

on:
  push:
    branches: [ main ]  # 监听main分支的push事件
  pull_request:
    branches: [ main ]  # 监听针对main分支的PR

jobs:
  build:
    runs-on: ubuntu-latest  # 使用Ubuntu环境

    steps:
    - uses: actions/checkout@v4  # 检出代码

    - name: Set up build environment
      run: |
        # 安装必要的编译工具
        sudo apt-get update
        sudo apt-get install -y g++

    - name: Make build script executable
      run: chmod +x build.sh  # 确保构建脚本可执行

    - name: Run build script
      id: build_step  # 给步骤设置ID，方便后续引用
      run: ./build.sh  # 执行构建脚本

    - name: Send success notification to Feishu
      if: success()  # 只有前面步骤成功时才执行
      run: |
        curl -X POST "${{ secrets.FEISHU_WEBHOOK }}" \
        -H "Content-Type: application/json" \
        -d '{
          "msg_type": "post",
          "content": {
            "post": {
              "zh_cn": {
                "title": "✅ 构建成功",
                "content": [
                  [
                    {"tag": "text", "text": "仓库名: "},
                    {"tag": "text", "text": "${{ github.repository }}", "style": "bold"},
                    {"tag": "text", "text": "\n"}
                  ],
                  [
                    {"tag": "text", "text": "分支: "},
                    {"tag": "text", "text": "${{ github.ref_name }}", "style": "bold"},
                    {"tag": "text", "text": "\n"}
                  ],
                  [
                    {"tag": "text", "text": "提交ID: "},
                    {"tag": "text", "text": "${{ github.sha }}", "style": "bold"},
                    {"tag": "text", "text": "\n"}
                  ],
                  [
                    {"tag": "text", "text": "提交者: "},
                    {"tag": "text", "text": "${{ github.actor }}", "style": "bold"},
                    {"tag": "text", "text": "\n"}
                  ],
                  [
                    {"tag": "text", "text": "查看详情: "},
                    {"tag": "a", "text": "GitHub Actions日志", "href": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}
                  ]
                ]
              }
            }
          }
        }'

    - name: Send failure notification to Feishu
      if: failure()  # 只有前面步骤失败时才执行
      run: |
        curl -X POST "${{ secrets.FEISHU_WEBHOOK }}" \
        -H "Content-Type: application/json" \
        -d '{
          "msg_type": "post",
          "content": {
            "post": {
              "zh_cn": {
                "title": "❌ 构建失败",
                "content": [
                  [
                    {"tag": "text", "text": "仓库名: "},
                    {"tag": "text", "text": "${{ github.repository }}", "style": "bold"},
                    {"tag": "text", "text": "\n"}
                  ],
                  [
                    {"tag": "text", "text": "分支: "},
                    {"tag": "text", "text": "${{ github.ref_name }}", "style": "bold"},
                    {"tag": "text", "text": "\n"}
                  ],
                  [
                    {"tag": "text", "text": "提交ID: "},
                    {"tag": "text", "text": "${{ github.sha }}", "style": "bold"},
                    {"tag": "text", "text": "\n"}
                  ],
                  [
                    {"tag": "text", "text": "提交者: "},
                    {"tag": "text", "text": "${{ github.actor }}", "style": "bold"},
                    {"tag": "text", "text": "\n"}
                  ],
                  [
                    {"tag": "text", "text": "查看详情: "},
                    {"tag": "a", "text": "GitHub Actions日志", "href": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}
                  ]
                ]
              }
            }
          }
        }'

